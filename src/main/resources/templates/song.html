<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Music Share - Spotify風音楽サイト</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link th:href="@{/css/style.css}" rel="stylesheet">

	<!-- ✅ CSRF トークンを Thymeleaf から埋め込む -->
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body>
	<!-- ヘッダー -->
	<header class="header">
		<div class="container">
			<div class="row align-items-center">
				<div class="col-md-3">
					<a href="/search" style="text-decoration: none;">
						<h2 class="mb-0 text-white">🎵 Melo Talk</h2>
					</a>
				</div>
				<div class="col-md-6">
					<div class="search-container">
						<input type="text" class="search-input" placeholder="楽曲、アーティスト、またはアルバムを検索" id="searchInput">
						<button type="button" class="search-button" onclick="handleSearch()">
							<svg class="search-icon" viewBox="0 0 24 24">
								<path
									d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
							</svg>
						</button>
						<!-- 検索候補ドロップダウン -->
						<div class="search-suggestions" id="searchSuggestions"></div>
					</div>
				</div>
				<div class="col-md-3 text-end">
					<span class="text-white">ようこそ、Melo Talk！</span>
				</div>
			</div>
		</div>
	</header>

	<!-- メインコンテンツ -->
	<main class="main-content">
		<!-- 楽曲カード -->
		<div class="song-card">
			<div class="song-info">
				<div class="song-details">
					<h3 th:text="${songTitle}">Song Name</h3>
					<p th:text="${artistName}" class="artist-name">Artist Name</p>
				</div>
			</div>

			<div class="action-buttons">
				<button class="like-btn-pa" onclick="toggleCommentLike(this)">
					<i class="heart-icon"></i> <span class="like-count">127</span>
					<span>いいね</span>
				</button>
			</div>

			<div class="comment-section">
				<h5>コメント</h5>

				<!-- コメント投稿フォーム -->
				<form id="commentForm">
					<input type="hidden" id="songId" name="songId" th:value="${songId}" />
					<input type="hidden" id="userId" name="userId" th:value="${userId}" />
					<input type="hidden" id="artistId" name="artistId" th:value="${artistId}" />

					<textarea name="commentText" class="comment-input" placeholder="コメントを書く..." required></textarea>
					<button type="submit" class="comment-button">コメントを投稿</button>
				</form>

				<!-- コメント一覧 -->
				<div id="comments-list" class="comments-list">
					<!-- 初期コメントはThymeleafでレンダリング -->
					<div th:each="comment : ${comments}" class="comment" th:data-comment-id="${comment.commentId}">
						<div class="comment-author">ユーザー[[${comment.user.userName}]]</div>
						<p class="comment-text" th:text="${comment.commentText}"></p>
						<div class="comment-actions">
							<button class="like-btn" onclick="toggleCommentLike(this)">
								<i class="heart-icon"></i> <span class="like-count">0</span>
							</button>
							<button class="reply-btn" onclick="toggleReplyForm(this)">返信する</button>

							<!-- String型同士の比較 -->
							<span th:if="${userId != null && #strings.equals(userId, comment.user.userId)}">
								<button class="edit-btn" onclick="editComment(this)">編集</button>
								<button class="delete-btn" onclick="showDeleteConfirm(this)">削除</button>
							</span>
						</div>

						<!-- 編集フォーム（初期非表示） -->
						<form class="edit-form d-none">
							<textarea name="commentText" th:text="${comment.commentText}" required></textarea>
							<button type="button" onclick="submitEdit(this)">保存</button>
							<button type="button" onclick="cancelEdit(this)">キャンセル</button>
						</form>

						<!-- 削除確認フォーム（初期非表示） -->
						<div class="delete-confirm d-none">
							<p>本当にこのコメントを削除しますか？</p>
							<button type="button" onclick="confirmDelete(this)">削除する</button>
							<button type="button" onclick="cancelDelete(this)">キャンセル</button>
						</div>

						<!-- 返信フォーム（初期非表示） -->
						<form class="reply-form d-none">
							<textarea name="commentText" placeholder="返信を書く..." required></textarea>
							<button type="button" onclick="submitReply(this)">返信を投稿</button>
						</form>

						<!-- 子コメント（返信）を表示 -->
						<div class="replies">
							<div th:each="reply : ${comment.replies}" class="comment reply"
								th:data-comment-id="${reply.commentId}">
								<div class="comment-author">ユーザー<span th:text="${reply.user.userName}"></span></div>
								<p class="comment-text" th:text="${reply.commentText}"></p>
								<div class="comment-actions">
									<button class="like-btn" onclick="toggleCommentLike(this)">
										<i class="heart-icon"></i> <span class="like-count">0</span>
									</button>
									<button class="reply-btn" onclick="toggleReplyForm(this)">返信する</button>

									<!-- String型同士の比較 -->
									<span th:if="${userId != null && #strings.equals(userId, reply.user.userId)}">
										<button class="edit-btn" onclick="editComment(this)">編集</button>
										<button class="delete-btn" onclick="showDeleteConfirm(this)">削除</button>
									</span>
								</div>

								<!-- 編集フォーム（初期非表示） -->
								<form class="edit-form d-none">
									<textarea name="commentText" th:text="${reply.commentText}" required></textarea>
									<button type="button" onclick="submitEdit(this)">保存</button>
									<button type="button" onclick="cancelEdit(this)">キャンセル</button>
								</form>

								<!-- 削除確認フォーム（初期非表示） -->
								<div class="delete-confirm d-none">
									<p>本当にこのコメントを削除しますか？</p>
									<button type="button" onclick="confirmDelete(this)">削除する</button>
									<button type="button" onclick="cancelDelete(this)">キャンセル</button>
								</div>

								<!-- 返信フォーム（初期非表示） -->
								<form class="reply-form d-none">
									<textarea name="commentText" placeholder="返信を書く..." required></textarea>
									<button type="button" onclick="submitReply(this)">返信を投稿</button>
								</form>

								<div class="replies"></div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
	</main>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/music-share.js"></script>

</html>